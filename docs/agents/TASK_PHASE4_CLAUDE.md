# Phase 4: Claude Code Tasks

> **Created:** 2025-11-29
> **For:** Claude Code Agent
> **Remaining Milestones:** M6, M7, M2-UI

---

## Context

Phase 4 milestones M1-M5 and M8 have been completed by GitHub Copilot.

**What's done:**
- âœ… M1: Realm/Campaign settings flow to LLM context
- âœ… M2: Campaign creation generates LLM milestones (backend API only)
- âœ… M3: Keeper has full context (realm, campaign, chapter, scene, previous turns)
- âœ… M4: Scene summarization via LLM on transition
- âœ… M5: Chapter summarization via LLM on transition
- âœ… M8: Frontend bugs fixed (autosave, combat collapse, relationships collapse)
- âœ… M8b: Markdown rendering in chat

**What's left:**
- ðŸŸ¡ M6: AI-controlled characters
- ðŸŸ¡ M7: NPC agent system
- ðŸŸ¡ M2-UI: Frontend for campaign settings (optional)

---

## M6: AI-Controlled Characters

### Goal
Allow characters to be marked as "AI-controlled" so the Keeper generates their actions automatically.

### Requirements

1. **Model changes** (`backend/app/models.py`):
   ```python
   class Character:
       # Add field
       ai_controlled: bool = False
       ai_personality: Optional[str] = None  # e.g., "cautious", "impulsive", "scholarly"
   ```

2. **Context assembly** (`backend/app/services/context_assembly.py`):
   - Include `ai_controlled` and `ai_personality` in character context
   - Flag which characters are AI vs player-controlled

3. **Turn processing** (`backend/app/routes_turns.py` or `services/transition.py`):
   - When processing a turn, check if any AI characters should act
   - Option A: AI characters act in same turn as players
   - Option B: AI characters get separate turns

4. **LLM prompt** (`n8n_workflows/LLM_Synthesizer_SubWF.json`):
   - If AI characters present, include section: "Generate actions for AI characters: [list]"
   - AI character actions should fit their personality

5. **Frontend** (`frontend/src/components/CharacterSheet/`):
   - Toggle for "AI Controlled" in character sheet
   - Personality dropdown or text field

### Key Files
- `backend/app/models.py` - Character model
- `backend/app/services/context_assembly.py` - CharacterContext class
- `backend/app/routes_turns.py` - Turn submission
- `n8n_workflows/LLM_Synthesizer_SubWF.json` - Prompt template
- `frontend/src/components/CharacterSheet/BasicInfoSection.vue` - Character basics

---

## M7: NPC Agent System

### Goal
Create a system where NPCs can be tracked and their actions generated by the LLM during gameplay.

### Requirements

1. **NPC Model** (`backend/app/models.py`):
   ```python
   class NPC(BaseModel):
       id: str
       name: str
       description: str
       role: str  # "ally", "enemy", "neutral", "mysterious"
       personality: str
       goals: List[str]
       knowledge: List[str]  # What do they know?
       current_location: Optional[str]
       status: str = "active"  # "active", "dead", "missing"
   ```

2. **Scene-level NPC tracking**:
   - Scenes should track which NPCs are present
   - Add to Scene model: `npcs_present: List[str]`

3. **NPC Context for LLM**:
   - Include present NPCs in scene context
   - LLM should generate NPC dialogue/actions when appropriate

4. **NPC Management Routes** (`backend/app/routes_npcs.py`):
   - CRUD for NPCs
   - Assign NPCs to campaigns/chapters
   - Track NPC state changes

5. **Frontend NPC Panel**:
   - View NPCs in current scene
   - Keeper can add/remove NPCs from scene
   - NPC status cards

### Key Files
- `backend/app/models.py` - Add NPC model
- `backend/app/routes_npcs.py` - New file
- `backend/app/services/context_assembly.py` - Add NPC context
- `n8n_workflows/LLM_Synthesizer_SubWF.json` - NPC section in prompt

---

## M2-UI: Campaign Settings Frontend (Optional)

### Goal
Add UI for setting campaign tone, goals, and story elements during creation.

### Requirements

1. **Campaign Creation Dialog** (`frontend/src/components/EntitySelectors/CampaignSelector.vue`):
   - Add fields: tone (dropdown), goal (text), story_elements (tags)
   - Pass `generate_milestones: true` and `setting` dict to API

2. **Campaign View**:
   - Display generated milestones
   - Show campaign tone/goal

### Key Files
- `frontend/src/components/EntitySelectors/CampaignSelector.vue`
- `frontend/src/api/campaigns.ts` - Update create() payload

---

## Testing Notes

### Test M2 (API)
```bash
curl -X POST http://localhost:8093/api/v1/campaigns \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Campaign",
    "realm_id": "realm-xxx",
    "status": "planning",
    "generate_milestones": true,
    "setting": {
      "tone": "cosmic horror",
      "goal": "investigate disappearances",
      "story_elements": ["cultists", "ancient tome"]
    },
    "created_by": "test"
  }'
```

### LLM Service Location
- `backend/app/services/llm.py` - Direct Ollama calls
- Uses `gpt-oss:20b` model at `http://host.docker.internal:11434`

---

## Architecture Notes

### LLM Integration Pattern
For M6/M7, use the existing `LLMService` in `backend/app/services/llm.py`:

```python
from backend.app.services.llm import llm_service

# Example: Generate NPC dialogue
response = await llm_service._call_llm(
    system_prompt="You are an NPC in a Call of Cthulhu game...",
    user_prompt="Generate a response for [NPC name]..."
)
```

### n8n Workflow Updates
If modifying the DungeonMaster workflow:
1. Export from n8n UI or edit JSON directly
2. Update `n8n_workflows/DungeonMaster_Main.json`
3. Import back to n8n

### Commit Convention
```
<type>: <description>

- Detail 1
- Detail 2
```
Types: `feat`, `fix`, `docs`, `refactor`

---

## Handoff Checklist

When completing these tasks:
- [ ] Update `docs/agents/HANDOFF_CONTEXT.md`
- [ ] Update `docs/architecture/FRICTION_POINTS.md` if issues found
- [ ] Create ADR for significant architectural decisions
- [ ] Test with actual gameplay if possible
